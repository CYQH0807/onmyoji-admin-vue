import{d as se}from"./dayjs-DOBku9Nj.js";import{j as R,u as H,i as L,a as A}from"./index-BzwtatPw.js";import"./store-BGvsPsWR.js";import{J as oe,a4 as ne,a5 as ae,a6 as le,B as ce,T as ie,a7 as re,m as ue}from"./@element-plus.icons-vue-BCFYf-67.js";import{A as de,d as z,t as Y,Y as c,$ as K,L as W,o as m,c as $,a as e,F as q,i as t,N as j,K as u,V as G,O as _e,n as P,J as F,E as pe}from"./@vue.runtime-core-B2X3lOUZ.js";import{d as Q}from"./pinia-ByvooDwk.js";import{r as C,u as l}from"./@vue.reactivity-V6IlnEmz.js";import{a as me}from"./@vueuse.core-Bp0bPelK.js";import{a as ve}from"./element-plus-DaJS5H-O.js";import{O as I,o as J}from"./@vue.shared-D-bMerGS.js";import{_ as X}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as fe}from"./index-OBXFyj3D.js";import{d as he}from"./lodash-es-I-EvhVFk.js";import"./chardet-C_72lc3Z.js";import"./@vue.runtime-dom-DkKQpP1Z.js";import"./mitt-C1z4c41a.js";import"./axios-CvWkLj0m.js";import"./nprogress-B7fG2QpQ.js";import"./monaco-editor-CuOEaJz6.js";import"./vue-echarts-BbwyaQnR.js";import"./resize-detector-CZu9PX2v.js";import"./echarts-Bv2MlBtc.js";import"./tslib-BDyQ-Jie.js";import"./zrender-BSc91FC-.js";import"./vue-router-4IlAtr41.js";import"./mockjs-Bfc9hT_P.js";import"./vue-xN6KRtQP.js";import"./@popperjs.core-D9SI2xQl.js";import"./@ctrl.tinycolor-r5W6hzzQ.js";import"./async-validator-CRbnkQr6.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-B6fDCfyv.js";import"./@floating-ui.dom-B8Qxuwjg.js";import"./@floating-ui.core-DTrSsA1T.js";import"./@floating-ui.utils-Bh-IyuRp.js";import"./@vueuse.shared-CZpoHp70.js";import"./vue-demi-Dq6ymT-8.js";function Z(){return{chat:de("chat")}}const ge=Q("chat-message",()=>{const v=C(!1),p=C([]),d=C({page:1,total:0,size:20});async function a(i){v.value=!0,(i==null?void 0:i.page)==1&&(p.value=[]),await R.chat.message.page(i).then(f=>{p.value=f.list.map(o=>(o.content=JSON.parse(o.content),o)),d.value=f.pagination}),v.value=!1}return{loading:v,list:p,pagination:d,get:a}}),xe=Q("chat-session",()=>{const v=C(!1),p=C([]),d=C();async function a(f){v.value=!0,await R.chat.session.page(f).then(o=>{d.value||i(o.list[0]),p.value=o.list}),v.value=!1}function i(f){d.value=f}return{loading:v,list:p,value:d,get:a,set:i}});function O(){const v=xe(),p=ge();return{session:v,message:p}}const ke={class:"chat-message","element-loading-text":"消息列表加载中"},ye={class:"head"},be={class:"avatar"},$e={class:"name"},Ce={class:"avatar"},we=["onContextmenu"],Me={class:"h"},Se={class:"name"},Te={class:"content"},Ve={key:0,class:"is-text"},Ne={key:1,class:"is-image"},Be={class:"footer"},Ie={class:"tools"},ze={class:"input"},De=z({name:"undefined"}),Ue=z({...De,setup(v){const{user:p}=H(),{chat:d}=Z(),{message:a,session:i}=O(),{copy:f}=me(),o=C(""),w=Y(()=>{let _=0;return a.list.map(n=>{var k;return n.contentType==1&&(n._index=_++),n.isMy=n.fromId==((k=p.info)==null?void 0:k.id),n})}),h=Y(()=>a.list.filter(_=>_.contentType==1).map(_=>{var n;return(n=_.content)==null?void 0:n.imageUrl}).filter(Boolean));function V(){d.send({contentType:0,content:{text:o.value}},!0),o.value=""}function g(_){d.send({contentType:1,content:{imageUrl:_.url}},!0),o.value=""}function x(_,n){L.ContextMenu.open(_,{hover:{target:"content"},list:[{label:"复制",callback(k){f(n.content.text||""),ve.success("复制成功"),k()}},{label:"转发"},{label:"删除"}]})}return(_,n)=>{var S,y,E,B;const k=c("cl-avatar"),D=c("el-image"),N=c("el-scrollbar"),M=c("el-icon"),U=c("cl-upload"),r=c("el-input"),s=c("el-button"),T=K("loading");return W((m(),$("div",ke,[e("div",ye,[(S=l(i))!=null&&S.value?(m(),$(q,{key:0},[e("div",be,[t(k,{size:30,shape:"square",src:(y=l(i))==null?void 0:y.value.avatar},null,8,["src"])]),e("span",$e,"与“"+I((E=l(i))==null?void 0:E.value.nickName)+"”聊天中",1)],64)):j("",!0)]),t(N,{class:"list"},{default:u(()=>[e("ul",null,[(m(!0),$(q,null,G(w.value,(b,ee)=>(m(),$("li",{key:ee},[e("div",{class:J(["item",{"is-right":b.isMy}])},[e("div",Ce,[t(k,{size:36,shape:"square",src:b.avatar},null,8,["src"])]),e("div",{class:"det",onContextmenu:te=>{x(te,b)}},[e("div",Me,[e("span",Se,I(b.nickName),1)]),e("div",Te,[b.contentType==0?(m(),$("div",Ve,[e("span",null,I(b.content.text),1)])):b.contentType==1?(m(),$("div",Ne,[t(D,{src:b.content.imageUrl,"preview-src-list":h.value,"initial-index":b._index,"scroll-container":".chat-message .list"},null,8,["src","preview-src-list","initial-index"])])):j("",!0)])],40,we)],2)]))),128))])]),_:1}),e("div",Be,[e("div",Ie,[e("ul",null,[t(U,{onSuccess:g,"show-file-list":!1},{default:u(()=>[e("li",null,[t(M,null,{default:u(()=>[t(l(oe))]),_:1})])]),_:1}),e("li",null,[t(M,null,{default:u(()=>[t(l(ne))]),_:1})]),e("li",null,[t(M,null,{default:u(()=>[t(l(ae))]),_:1})]),e("li",null,[t(M,null,{default:u(()=>[t(l(le))]),_:1})])])]),e("div",ze,[t(r,{modelValue:o.value,"onUpdate:modelValue":n[0]||(n[0]=b=>o.value=b),type:"textarea",rows:4,resize:"none",autosize:{minRows:4,maxRows:10},placeholder:"输入内容"},null,8,["modelValue"]),t(s,{type:"success",onClick:V,disabled:!o.value},{default:u(()=>[_e("发送")]),_:1},8,["disabled"])])])])),[[T,(B=l(a))==null?void 0:B.loading]])}}}),Ee=X(Ue,[["__scopeId","data-v-50781a32"]]),Ye={class:"chat-session"},qe={class:"head"},je={class:"tools"},Fe={class:"list"},Je=["onClick"],Oe={class:"avatar"},Re={class:"det"},He={class:"name"},Le={class:"message"},Ae={class:"status"},Ke={class:"date"},We=z({name:"undefined"}),Ge=z({...We,setup(v){const{browser:p}=A(),{chat:d}=Z(),{session:a,message:i}=O(),{refs:f,setRefs:o}=fe();L.useDialog({onFullscreen(){P(()=>{var g;(g=f.scroller)==null||g.update()})}});const w=C(""),h=Y(()=>(a==null?void 0:a.list.filter(g=>{var x;return(x=g.nickName)==null?void 0:x.includes(w.value)}))||[]);async function V(g){p.isMini&&d.expand(!1),a.set(g),await i.get({page:1}),d.scrollToBottom()}return(g,x)=>{var r;const _=c("el-input"),n=c("el-icon"),k=c("cl-avatar"),D=c("el-badge"),N=c("el-empty"),M=c("el-scrollbar"),U=K("loading");return m(),$("div",Ye,[e("div",qe,[t(_,{modelValue:w.value,"onUpdate:modelValue":x[0]||(x[0]=s=>w.value=s),placeholder:"关键字搜索",clearable:""},null,8,["modelValue"]),e("ul",je,[e("li",null,[t(n,null,{default:u(()=>[t(l(ce))]),_:1})]),e("li",{onClick:x[1]||(x[1]=s=>l(a).get())},[t(n,null,{default:u(()=>[t(l(ie))]),_:1})])])]),W((m(),$("div",Fe,[t(M,{class:"scroller",ref:l(o)("scroller")},{default:u(()=>[(m(!0),$(q,null,G(h.value,(s,T)=>{var S,y;return m(),$("div",{class:J(["item",{"is-active":s.id==((y=(S=l(a))==null?void 0:S.value)==null?void 0:y.id)}]),key:T,onClick:E=>V(s)},[e("div",Oe,[t(D,{value:s.num,hidden:s.num==0},{default:u(()=>[t(k,{shape:"square",src:s.avatar},null,8,["src"])]),_:2},1032,["value","hidden"])]),e("div",Re,[e("p",He,I(s.nickName),1),e("p",Le,I(s.text),1)]),e("div",Ae,[e("p",Ke,I(s.createTime),1)])],10,Je)}),128)),h.value.length==0?(m(),F(N,{key:0,"image-size":100,description:"暂无会话"})):j("",!0)]),_:1},512)])),[[U,(r=l(a))==null?void 0:r.loading]])])}}}),Pe=X(Ge,[["__scopeId","data-v-490e6747"]]),Qe={class:"cl-chat__wrap"},Xe={class:"cl-chat__session"},Ze={class:"cl-chat__right"},et={class:"cl-dialog__controls-icon"},tt=z({name:"cl-chat"}),jt=z({...tt,setup(v,{expose:p}){const{browser:d,onScreenChange:a}=A(),{session:i,message:f}=O(),{user:o}=H(),w=C(!1),h=C(!0),V=C(parseInt(String(Math.random()*100)));let g;function x(){U()}function _(){w.value=!0,x()}function n(){w.value=!1}function k(r){h.value=r===void 0?!h.value:r}function D(r,s){s&&N(r)}function N(r){var s,T,S,y;f.list.push({fromId:(s=o.info)==null?void 0:s.id,toId:(T=i.value)==null?void 0:T.userId,avatar:(S=o.info)==null?void 0:S.headImg,nickName:(y=o.info)==null?void 0:y.nickName,createTime:se().format("YYYY-MM-DD HH:mm:ss"),...r}),M()}const M=he(()=>{P(()=>{const r=document.querySelector(".cl-chat .chat-message .list");r==null||r.scroll({top:1e5+Math.random(),behavior:"smooth"})})},300);async function U(){await i.get(),await f.get(),M()}return pe("chat",{get socket(){return g},send:D,append:N,expand:k,scrollToBottom:M}),a(()=>{h.value=!d.isMini}),p({open:_,close:n}),(r,s)=>{const T=c("cl-svg"),S=c("el-badge"),y=c("el-icon"),E=c("cl-dialog");return m(),$("div",Qe,[t(S,{value:V.value,hidden:!V.value},{default:u(()=>[e("div",{class:"cl-chat__icon",onClick:_},[t(T,{name:"icon-notice",size:16})])]),_:1},8,["value","hidden"]),t(E,{modelValue:w.value,"onUpdate:modelValue":s[2]||(s[2]=B=>w.value=B),title:"聊天窗口",height:"70vh",width:"1200px",padding:"0","keep-alive":"",scrollbar:!1,"close-on-click-modal":!1,"close-on-press-escape":"",controls:["slot-expand","cl-flex1","fullscreen","close"]},{"slot-expand":u(()=>[e("button",et,[h.value?(m(),F(y,{key:1,onClick:s[1]||(s[1]=B=>h.value=!1)},{default:u(()=>[t(l(ue))]),_:1})):(m(),F(y,{key:0,onClick:s[0]||(s[0]=B=>h.value=!0)},{default:u(()=>[t(l(re))]),_:1}))])]),default:u(()=>[e("div",{class:J(["cl-chat",{"is-mini":l(d).isMini,"is-expand":h.value}])},[e("div",Xe,[t(Pe)]),e("div",Ze,[t(Ee)])],2)]),_:1},8,["modelValue"])])}}});export{jt as default};
