import{i as I,e as Z,r as ee,f as S}from"./index-BzwtatPw.js";import"./store-BGvsPsWR.js";import{u as J}from"./index-OBXFyj3D.js";import{v as te,w as ne}from"./@vue.runtime-dom-DkKQpP1Z.js";import{T as oe,U as re,E as le}from"./@element-plus.icons-vue-BCFYf-67.js";import{u as H}from"./group-BfmV4XTx.js";import{b as U,a as C}from"./element-plus-DaJS5H-O.js";import{x as se}from"./lodash-es-I-EvhVFk.js";import{d as D,e as ae,Y as i,$ as Q,o as N,c as A,a as x,i as n,K as p,N as j,L as G,O as L,J as O,n as ie,av as pe,au as ce}from"./@vue.runtime-core-B2X3lOUZ.js";import{r as R,u as h}from"./@vue.reactivity-V6IlnEmz.js";import{o as de,O as ue}from"./@vue.shared-D-bMerGS.js";import{_ as me}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./@vueuse.core-Bp0bPelK.js";import"./@vueuse.shared-CZpoHp70.js";import"./mitt-C1z4c41a.js";import"./axios-CvWkLj0m.js";import"./nprogress-B7fG2QpQ.js";import"./chardet-C_72lc3Z.js";import"./pinia-ByvooDwk.js";import"./vue-demi-Dq6ymT-8.js";import"./monaco-editor-CuOEaJz6.js";import"./vue-echarts-BbwyaQnR.js";import"./resize-detector-CZu9PX2v.js";import"./echarts-Bv2MlBtc.js";import"./tslib-BDyQ-Jie.js";import"./zrender-BSc91FC-.js";import"./vue-router-4IlAtr41.js";import"./mockjs-Bfc9hT_P.js";import"./dayjs-DOBku9Nj.js";import"./vue-xN6KRtQP.js";import"./@popperjs.core-D9SI2xQl.js";import"./@ctrl.tinycolor-r5W6hzzQ.js";import"./async-validator-CRbnkQr6.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-B6fDCfyv.js";import"./@floating-ui.dom-B8Qxuwjg.js";import"./@floating-ui.core-DTrSsA1T.js";import"./@floating-ui.utils-Bh-IyuRp.js";const _e=g=>(pe("data-v-37b66435"),g=g(),ce(),g),fe={class:"dept-tree"},be={class:"dept-tree__header"},he=_e(()=>x("div",null,"组织架构",-1)),ve={class:"dept-tree__op"},ge={class:"no"},we={class:"dept-tree__node"},ye=["onClick"],ke=D({name:"dept-list"}),xe=D({...ke,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["refresh","user-add"],setup(g,{emit:w}){const B=g,$=w,{service:_,browser:y}=J(),v=I.useForm(),{ViewGroup:d}=H(),u=R([]),k=R(!1),f=R(!1);function r({data:t}){return t.parentId}function l(t,e){return e.data.parentId}async function c(){k.value=!0,f.value=!1,await _.base.sys.department.list().then(t=>{var e;u.value=Z(t),(e=d.value)!=null&&e.selected||b()}),k.value=!1}function b(t){var e;if(t||(t=u.value[0]),t){const s=t.children?ee(t.children).map(o=>o.id):[];s.unshift(t.id),(e=d.value)==null||e.select(t),ie(()=>{$("refresh",{page:1,departmentIds:s})})}}function F(t){var s;const e=t.id?"update":"add";(s=v.value)==null||s.open({title:"编辑部门",width:"550px",props:{labelWidth:"100px"},items:[{label:"部门名称",prop:"name",component:{name:"el-input"},required:!0},{label:"上级部门",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:{...t},on:{submit(o,{done:a,close:m}){_.base.sys.department[e]({id:t.id,parentId:t.parentId,name:o.name,orderNum:o.orderNum}).then(()=>{C.success(`新增部门 “${o.name}” 成功`),m(),c()}).catch(M=>{C.error(M.message),a()})}}})}function q(t){async function e(s){await _.base.sys.department.delete({ids:[t.id],deleteUser:s}).then(()=>{var o,a;((a=(o=d.value)==null?void 0:o.selected)==null?void 0:a.id)==t.id&&b(),s?C.success("删除成功"):U.confirm(`“${t.name}” 部门的用户已成功转移到 “${t.parentName}” 部门。`,"删除成功")}),c()}U.confirm(`此操作将会删除 “${t.name}” 部门的所有用户，是否确认？`,"提示",{type:"warning",confirmButtonText:"直接删除",cancelButtonText:"保留用户",distinguishCancelAndClose:!0}).then(()=>{e(!0)}).catch(s=>{s=="cancel"&&e(!1)})}function V(t){t?U.confirm("部门架构已发生改变，是否保存？","提示",{type:"warning"}).then(async()=>{const e=[];function s(o,a){o.forEach(m=>{m.parentId=a,e.push(m),m.children&&se(m.children)&&s(m.children,m.id)})}s(u.value,null),await _.base.sys.department.order(e.map((o,a)=>({id:o.id,parentId:o.parentId,orderNum:a}))).then(()=>{C.success("更新排序成功")}).catch(o=>{C.error(o.message)}),c(),f.value=!1}).catch(()=>null):c()}function E(t,e,s){e||(e=u.value[0]||{});const o=_.base.sys.department.permission;I.ContextMenu.open(t,{list:[{label:"新增",hidden:s&&s.level>=B.level||!S(o.add),callback(a){F({name:"",parentName:e.name,parentId:e.id}),a()}},{label:"编辑",hidden:!S(o.update),callback(a){F(e),a()}},{label:"删除",hidden:!e.parentId||!S(o.delete),callback(a){q(e),a()}},{label:"新增成员",hidden:!S(o.add),callback(a){$("user-add",e),a()}}]})}return ae(function(){c()}),(t,e)=>{const s=i("el-icon"),o=i("el-tooltip"),a=i("el-button"),m=i("el-tree"),M=i("el-scrollbar"),T=i("cl-form"),z=Q("loading");return N(),A("div",fe,[x("div",be,[he,x("ul",ve,[x("li",{onClick:e[0]||(e[0]=W=>c())},[n(o,{content:"刷新"},{default:p(()=>[n(s,null,{default:p(()=>[n(h(oe))]),_:1})]),_:1})]),g.drag&&!h(y).isMini?(N(),A("li",{key:0,onClick:e[1]||(e[1]=W=>f.value=!0)},[n(o,{content:"拖动排序"},{default:p(()=>[n(s,null,{default:p(()=>[n(h(re))]),_:1})]),_:1})])):j("",!0),G(x("li",ge,[n(a,{onClick:e[2]||(e[2]=W=>V(!0)),size:"small"},{default:p(()=>[L("保存")]),_:1}),n(a,{onClick:e[3]||(e[3]=W=>V(!1)),size:"small"},{default:p(()=>[L("取消")]),_:1})],512),[[te,f.value]])])]),x("div",{class:"dept-tree__container",onContextmenu:ne(E,["stop","prevent"])},[n(M,null,{default:p(()=>[G((N(),O(m,{"node-key":"id","default-expand-all":"",data:u.value,props:{label:"name"},"highlight-current":"",draggable:f.value,"allow-drag":r,"allow-drop":l,"expand-on-click-node":!1,onNodeContextmenu:E,onNodeClick:b},{default:p(({node:W,data:K})=>{var P,Y;return[x("div",we,[x("span",{class:de(["dept-tree__node-label",{"is-active":K.id==((Y=(P=h(d))==null?void 0:P.selected)==null?void 0:Y.id)}])},ue(W.label),3),h(y).isMini?(N(),A("span",{key:0,class:"dept-tree__node-icon",onClick:X=>E(X,K,W)},[n(s,null,{default:p(()=>[n(h(le))]),_:1})],8,ye)):j("",!0)])]}),_:1},8,["data","draggable"])),[[z,k.value]])]),_:1})],32),n(T,{ref_key:"Form",ref:v},null,512)])}}}),Ce=me(xe,[["__scopeId","data-v-37b66435"]]),Ie={class:"dept-move"},Ne=D({name:"user-move"}),$e=D({...Ne,setup(g,{expose:w}){const{service:B}=J(),$=I.useForm(),_=I.useCrud();async function y(v){var d;(d=$.value)==null||d.open({title:"部门转移",width:"500px",props:{labelWidth:"80px"},items:[{label:"选择部门",prop:"departmentId",component:{name:"cl-dept-select"}}],on:{submit(u,{done:k,close:f}){if(!u.departmentId)return C.warning("请选择部门"),k();U.confirm("转移到新部门，是否继续？","提示",{type:"warning"}).then(()=>{B.base.sys.user.move({...u,userIds:v}).then(()=>{var r;C.success("转移成功"),(r=_.value)==null||r.refresh(),f()}).catch(r=>{C.error(r.message),k()})}).catch(()=>null)}}})}return w({open:y}),(v,d)=>{const u=i("cl-form");return N(),A("div",Ie,[n(u,{ref_key:"Form",ref:$},null,512)])}}}),Me=D({name:"sys-user"}),mt=D({...Me,setup(g){const{service:w,refs:B,setRefs:$}=J(),{ViewGroup:_}=H({title:"用户列表"}),y=I.useCrud({service:w.base.sys.user}),v=I.useTable({columns:[{type:"selection",width:60},{prop:"headImg",label:"头像",component:{name:"cl-avatar"}},{prop:"username",label:"用户名",minWidth:150},{prop:"name",label:"姓名",minWidth:150},{prop:"nickName",label:"昵称",minWidth:150},{prop:"departmentName",label:"部门名称",minWidth:150},{prop:"roleName",label:"角色",headerAlign:"center",minWidth:150,dict:[],formatter(r){var l;return(l=r.roleName)==null?void 0:l.split(",")}},{prop:"status",label:"状态",minWidth:120,component:{name:"cl-switch"}},{prop:"phone",label:"手机号码",minWidth:150},{prop:"remark",label:"备注",minWidth:150},{prop:"createTime",label:"创建时间",sortable:"desc",minWidth:160},{type:"op",buttons:["slot-btn","edit","delete"],width:240}]}),d=I.useUpsert({dialog:{width:"800px"},items:[{prop:"headImg",label:"头像",component:{name:"cl-upload",props:{text:"选择头像"}}},{prop:"name",label:"姓名",span:12,required:!0,component:{name:"el-input"}},{prop:"nickName",label:"昵称",required:!0,span:12,component:{name:"el-input"}},{prop:"username",label:"用户名",required:!0,span:12,component:{name:"el-input"}},()=>{var r;return{prop:"password",label:"密码",span:12,required:((r=d.value)==null?void 0:r.mode)=="add",component:{name:"el-input",props:{type:"password"}},rules:[{min:6,max:16,message:"密码长度在 6 到 16 个字符"}]}},{prop:"roleIdList",label:"角色",value:[],required:!0,component:{name:"el-select",options:[],props:{multiple:!0,"multiple-limit":3}}},{prop:"phone",label:"手机号码",span:12,component:{name:"el-input"}},{prop:"email",label:"邮箱",span:12,component:{name:"el-input"}},{prop:"remark",label:"备注",component:{name:"el-input",props:{type:"textarea",rows:4}}},{prop:"status",label:"状态",value:1,component:{name:"el-radio-group",options:[{label:"开启",value:1},{label:"关闭",value:0}]}}],onSubmit(r,{next:l}){var c,b;l({departmentId:(b=(c=_.value)==null?void 0:c.selected)==null?void 0:b.id,...r})},async onOpen(){w.base.sys.role.list().then(r=>{var l;(l=d.value)==null||l.setOptions("roleIdList",r.map(c=>({label:c.name||"",value:c.id})))})},plugins:[I.setFocus("name")]});function u(r){var l;(l=y.value)==null||l.refresh(r)}function k({id:r}){var l;(l=y.value)==null||l.rowAppend({departmentId:r})}async function f(r){var c;let l=[];r?l=[r.id]:l=((c=v.value)==null?void 0:c.selection.map(b=>b.id))||[],B.userMove.open(l)}return(r,l)=>{const c=i("cl-refresh-btn"),b=i("cl-add-btn"),F=i("cl-multi-delete-btn"),q=i("el-button"),V=i("cl-flex1"),E=i("cl-search-key"),t=i("cl-row"),e=i("cl-table"),s=i("cl-pagination"),o=i("cl-upsert"),a=i("cl-crud"),m=i("cl-view-group"),M=Q("permission");return N(),O(m,{ref_key:"ViewGroup",ref:_},{left:p(()=>[n(Ce,{onRefresh:u,onUserAdd:k})]),right:p(()=>[n(a,{ref_key:"Crud",ref:y},{default:p(()=>[n(t,null,{default:p(()=>{var T;return[n(c),n(b),n(F),G((N(),O(q,{type:"success",disabled:((T=h(v))==null?void 0:T.selection.length)==0,onClick:l[0]||(l[0]=z=>f())},{default:p(()=>[L("转移")]),_:1},8,["disabled"])),[[M,h(w).base.sys.user.permission.move]]),n(V),n(E,{placeholder:"搜索用户名、姓名"})]}),_:1}),n(t,null,{default:p(()=>[n(e,{ref_key:"Table",ref:v},{"slot-btn":p(({scope:T})=>[G((N(),O(q,{text:"",bg:"",onClick:z=>f(T.row)},{default:p(()=>[L("转移")]),_:2},1032,["onClick"])),[[M,h(w).base.sys.user.permission.move]])]),_:1},512)]),_:1}),n(t,null,{default:p(()=>[n(V),n(s)]),_:1}),n(o,{ref_key:"Upsert",ref:d},null,512),n($e,{ref:h($)("userMove")},null,512)]),_:1},512)]),_:1},512)}}});export{mt as default};
