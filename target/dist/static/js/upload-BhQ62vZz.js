import{l as se}from"./@vue.runtime-dom-DkKQpP1Z.js";import{V as ie}from"./vuedraggable-CVtBI3ut.js";import{$ as re,J as ue}from"./@element-plus.icons-vue-BCFYf-67.js";import{m as ne,u as te,x as ae,j as E,i as de,y as ce}from"./index-BzwtatPw.js";import{u as pe}from"./index-OBXFyj3D.js";import{p as H,g as Q,a as W,U as me}from"./index-B9NYsrmA.js";import{o as fe,x as X,w as ge,y as he}from"./lodash-es-I-EvhVFk.js";import{a as D}from"./element-plus-DaJS5H-O.js";import{d as oe,t as v,q as be,Y as I,o as c,c as y,a as M,F as ve,i as g,K as h,G as L,N as F,J as j,n as Z,O as ye,M as we}from"./@vue.runtime-core-B2X3lOUZ.js";import{r as ke,u as B}from"./@vue.reactivity-V6IlnEmz.js";import{o as ee,O as J}from"./@vue.shared-D-bMerGS.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./sortablejs-GwZ5MQS7.js";import"./chardet-C_72lc3Z.js";import"./vue-xN6KRtQP.js";import"./@vueuse.core-Bp0bPelK.js";import"./@vueuse.shared-CZpoHp70.js";import"./store-BGvsPsWR.js";import"./mitt-C1z4c41a.js";import"./axios-CvWkLj0m.js";import"./nprogress-B7fG2QpQ.js";import"./pinia-ByvooDwk.js";import"./vue-demi-Dq6ymT-8.js";import"./monaco-editor-CuOEaJz6.js";import"./vue-echarts-BbwyaQnR.js";import"./resize-detector-CZu9PX2v.js";import"./echarts-Bv2MlBtc.js";import"./tslib-BDyQ-Jie.js";import"./zrender-BSc91FC-.js";import"./vue-router-4IlAtr41.js";import"./mockjs-Bfc9hT_P.js";import"./dayjs-DOBku9Nj.js";import"./@popperjs.core-D9SI2xQl.js";import"./@ctrl.tinycolor-r5W6hzzQ.js";import"./async-validator-CRbnkQr6.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-B6fDCfyv.js";import"./@floating-ui.dom-B8Qxuwjg.js";import"./@floating-ui.core-DTrSsA1T.js";import"./@floating-ui.utils-Bh-IyuRp.js";function xe(){const{options:s}=ne.get("upload"),{user:P}=te();async function A(o,b={}){return new Promise(async(w,k)=>{const{prefixPath:$,onProgress:U}=fe(b,s),_=ae("");try{const{mode:z,type:V}=await E.base.comm.uploadMode(),n=z=="local",C=_+"_"+o.name;let d=n?C:H($,C);async function p({host:i,preview:r,data:N}){const m=new FormData;m.append("key",d);for(const u in N)m.has(u)||m.append(u,N[u]);m.append("file",o),await E.request({url:i,method:"POST",headers:{"Content-Type":"multipart/form-data",Authorization:n?P.token:null},timeout:6e5,data:m,onUploadProgress(u){const f=u.total?Math.floor(u.loaded/u.total*100):0;U==null||U(f)},proxy:n,NProgress:!1}).then(u=>{d=encodeURIComponent(d);let f="";n?f=u:f=H(r||i,d),w({key:d,url:f,fileId:_})}).catch(u=>{D.error(u.message),k(u)})}n?p({host:"/admin/base/comm/upload"}):E.base.comm.upload(V=="aws"?{key:d}:{}).then(i=>{switch(V){case"cos":p({host:i.url,data:i.credentials});break;case"oss":p({host:i.host,preview:i.publicDomain,data:{OSSAccessKeyId:i.OSSAccessKeyId,policy:i.policy,signature:i.signature}});break;case"qiniu":p({host:i.uploadUrl,preview:i.publicDomain,data:{token:i.token}});break;case"aws":p({host:i.url,data:i.fields});break}}).catch(k)}catch(z){D.error("文件上传失败"),k(z)}})}return{options:s,toUpload:A}}const Se={key:0,class:"cl-upload__file-btn"},Be={key:0,class:"cl-upload__footer"},Ue={key:0,class:"cl-upload__demo is-dragger"},ze={key:1,class:"cl-upload__demo"},Ve={key:0,class:"text"},Ce={class:"cl-upload__item"},Fe=oe({name:"cl-upload"}),Ne=oe({...Fe,props:{modelValue:{type:[String,Array],default:()=>[]},type:{type:String,default:"image"},accept:String,multiple:Boolean,limit:Number,limitSize:Number,autoUpload:{type:Boolean,default:!0},size:[String,Number,Array],icon:null,text:String,showTag:{type:Boolean,default:!0},showFileList:{type:Boolean,default:!0},draggable:Boolean,drag:Boolean,disabled:Boolean,deletable:Boolean,customClass:String,beforeUpload:Function,prefixPath:String,isEdit:Boolean,scope:Object,prop:String,isDisabled:Boolean},emits:["update:modelValue","upload","success","error","progress"],setup(s,{expose:P,emit:A}){se(e=>({"26b8f93b":V.value[0],"26b8f95a":V.value[1]}));const o=s,b=A,{refs:w,setRefs:k}=pe(),{user:$}=te(),U=de.useForm(),{options:_,toUpload:z}=xe(),V=v(()=>{const e=o.size||_.size;return(X(e)?e:[e,e]).map(t=>ge(t)?t+"px":t)}),n=v(()=>o.isDisabled||o.disabled),C=o.limit||_.limit.upload,d=o.limitSize||_.limit.size,p=v(()=>{if(o.text!==void 0)return o.text;switch(o.type){case"file":return"选择文件";case"image":return"选择图片";default:return""}}),i=v(()=>({Authorization:$.token})),r=ke([]),N=v(()=>o.type=="file"?!he(r.value):!0),m=v(()=>o.accept||(o.type=="file"?"":"image/*")),u=v(()=>{let e=r.value.length;return o.multiple&&!n.value?C-e>0:e==0});async function f(e,t){function a(){const l={uid:e.uid,size:e.size,name:e.name,type:W(e.name),progress:o.autoUpload?0:100,url:"",preload:"",error:""};if(l.type=="image"&&e instanceof File&&(l.preload=window.webkitURL.createObjectURL(e)),b("upload",l,e),t)Object.assign(t,l);else if(o.multiple)if(u.value)r.value.push(l);else return D.warning(`最多只能上传${C}个文件`),!1;else r.value=[l];return!0}if(o.beforeUpload){let l=o.beforeUpload(e,t,{next:a});return ce(l)?l.then(a).catch(()=>null):l&&(l=a()),l}else return e.size/1024/1024>=d?(D.error(`上传文件大小不能超过 ${d}MB!`),!1):a()}function K(e){r.value.splice(e,1),T()}function G(){r.value=[]}async function q(e,t){if(t||(t=r.value.find(a=>a.uid==e.file.uid)),!t)return!1;z(e.file,{prefixPath:o.prefixPath,onProgress(a){t.progress=a,b("progress",t)}}).then(a=>{Object.assign(t,a),b("success",t),T()}).catch(a=>{t.error=a.message,b("error",t)})}function R(){return r.value.find(e=>!e.url)}function T(){if(!R()){const e=Q(r.value);b("update:modelValue",o.multiple?Q(r.value):e[0]||""),Z(()=>{var t,a;o.prop&&((t=U.value)==null||t.validateField(o.prop)),(a=w.upload)==null||a.clearFiles()})}}function le(e){var t;G(),(t=w.upload)==null||t.clearFiles(),Z(()=>{var a,l;(a=w.upload)==null||a.handleStart(e),(l=w.upload)==null||l.submit()})}return be(()=>o.modelValue,e=>{if(R())return!1;const t=(X(e)?e:[e]).filter(Boolean);r.value=t.map((a,l)=>{const x=r.value[l]||{};return Object.assign({progress:100,uid:ae()},x,{type:W(a),url:a,preload:x.url==a?x.preload:a})}).filter((a,l)=>o.multiple?!0:l==0)},{immediate:!0}),P({isAdd:u,list:r,check:R,clear:G,remove:K,upload:le}),(e,t)=>{const a=I("el-button"),l=I("el-upload"),x=I("el-icon");return c(),y("div",{class:ee(["cl-upload__wrap",[s.customClass]])},[M("div",{class:ee(["cl-upload",[`cl-upload--${s.type}`,{"is-disabled":n.value,"is-multiple":s.multiple}]])},[s.drag?F("",!0):(c(),y(ve,{key:0},[s.type=="file"?(c(),y("div",Se,[g(l,{ref:B(k)("upload"),drag:s.drag,action:"",accept:m.value,"show-file-list":!1,"before-upload":f,"http-request":q,headers:i.value,multiple:s.multiple,disabled:n.value},{default:h(()=>[L(e.$slots,"default",{},()=>[g(a,{type:"success"},{default:h(()=>[ye(J(p.value),1)]),_:1})],!0)]),_:3},8,["drag","accept","headers","multiple","disabled"])])):F("",!0)],64)),N.value?(c(),j(B(ie),{key:1,class:"cl-upload__list",tag:"div",modelValue:r.value,"onUpdate:modelValue":t[0]||(t[0]=S=>r.value=S),"ghost-class":"Ghost","drag-class":"Drag","item-key":"uid",disabled:!s.draggable,onEnd:T},{footer:h(()=>[(s.type=="image"||s.drag)&&u.value?(c(),y("div",Be,[g(l,{action:"",drag:s.drag,ref:B(k)("upload"),accept:m.value,"show-file-list":!1,"before-upload":f,"http-request":q,headers:i.value,multiple:s.multiple,disabled:n.value},{default:h(()=>[L(e.$slots,"default",{},()=>[s.drag?(c(),y("div",Ue,[g(x,{size:46},{default:h(()=>[g(B(re))]),_:1}),M("div",null," 点击上传或将文件拖动到此处，文件大小限制"+J(B(d))+"M ",1)])):(c(),y("div",ze,[g(x,{size:36},{default:h(()=>[s.icon?(c(),j(we(s.icon),{key:0})):(c(),j(B(ue),{key:1}))]),_:1}),p.value?(c(),y("span",Ve,J(p.value),1)):F("",!0)]))],!0)]),_:3},8,["drag","accept","headers","multiple","disabled"])])):F("",!0)]),item:h(({element:S,index:Y})=>[g(l,{action:"",accept:m.value,"show-file-list":!1,"http-request":O=>q(O,S),"before-upload":O=>{f(O,S)},headers:i.value,disabled:n.value},{default:h(()=>[L(e.$slots,"item",{item:S,index:Y},()=>[M("div",Ce,[g(me,{"show-tag":s.showTag,item:S,list:r.value,disabled:n.value,deletable:s.deletable,onRemove:O=>K(Y)},null,8,["show-tag","item","list","disabled","deletable","onRemove"])])],!0)]),_:2},1032,["accept","http-request","before-upload","headers","disabled"])]),_:3},8,["modelValue","disabled"])):F("",!0)],2)],2)}}}),vt=_e(Ne,[["__scopeId","data-v-7c61d7ea"]]);export{vt as default};
